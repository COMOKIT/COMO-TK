# COMOKIT-HPC
ToolKit to launch COMOKIT on a HPC (primary SLURM job scheduler x COMOKIT OpenJDK8)

# How to use :

## Genere XML

```
$ python generateMultipleXML.py -h
usage: generateMultipleXML.py [-h] [-r INT] [-s INT] [-f INT] [-o STR] -xml <experiment name>
                              /path/to/file.gaml /path/to/file.xml

optional arguments:
  -h, --help            show this help message and exit
  -r INT, --replication INT
                        Number of replication for each paramater space
  -s INT, --split INT   Split XML file every S replications
  -f INT, --final INT   Final step for simulations
  -o STR, --output STR  Path to folder where save output CSV
  -xml <experiment name> /path/to/file.gaml /path/to/file.xml
                        Classical xml arguments
```

**Example**
```
$ python generateMultipleXML.py -xml "Headless" ~/Documents/COMOKIT/Models/COMOKIT/Experiments/Physical\ Interventions/Significance\ of\ Wearing\ Masks.gaml /tmp/headless/mask.xml -r 1000 -s 36 -f 5000
```

## Genere SLURM configuration file

```
$ python generateJavaConfFile.py -h
usage: generateJavaConfFile.py [-h] [-n] [-c] [-f] [-x] -g  [-o]

optional arguments:
  -h, --help      show this help message and exit
  -n , --node     Number of nodes to dispatch your exploration on
  -c , --core     Number of cores per node
  -f , --folder   Absolute path to folder where your XML are stored (will gather EVERY! XML file)
  -x , --xml      Absolute path to your XML (/path/to/your/headlessExplo.xml)
  -g , --gama     Absolute path to GAMA headless script (/path/to/your/gama/headless/gama-
                  headless.sh)
  -o , --output   Path to your saved conf file (default: "./gama-headless.conf")
```

**Example**
```
$ python generateJavaConfFile.py -f /tmp/headless -g ~/.local/share/GAMA_Continuous_Linux/headless/gama-headless.sh -n 50 -c 36
```

## Aggregating output

Assuming your directory tree is composed of different subfolders, each representing a combination of parameters with multiple CSV file for each simulation performed for that given combination, it is possible to aggregate the data for one combination of parameters into one CSV, getting the mean, median, minimum, maximum, 5th and 95th percentiles, 25th and 975th permilles of the simulations. The commandline, if R is installed and correctly set in the PATH variable, is: 

```
$ Rscript aggregate.R input_folder output_folder nb_step
usage: aggregate.R input_folder output_folder nb_step

```
with (in that exact order): 
* input_folder the parent folder of the data generated by the model
* output_folder the target folder that will contain the resulting CSV files
* nb_step the maximum number of steps for all simulations

**Remarks**
The number of simulations is depending on the number of files named \*_building.csv . The CSV files generated by GAMA must have the followin columns, in that exact order, for age categories: 
* cumulative incidence, 
* number of individuals needing hospitalisations, 
* number of individuals needing ICU care, 
* number of susceptible individuals, 
* number of latent individuals, 
* number of asymptomatic individuals, 
* number of presymptomatic individuals, 
* number of symptomatic individuals, 
* number of recovered individuals, 
* number of dead individuals,
with each row representing the given number for a step of a simulation.

Age categories are expected to be splitted in 5-year gap categories, starting from 0-4, 5-9, up to 95 and over. 

For building, generated files are expected to contain one column per type of building, and one row represents the cumulative number of infections that happened in that type of building for a step of a simulation. 

Building types are expected to be the following:
"","school","shop","place_of_worship","meeting","restaurant","coffee","supermarket","playground","supplypoint","market","industry","hotel","karaoke", 
with "" being buildings without any type. 

**Example**
```
$ Rscript aggregate.R ./Documents/batch_output ./Documents/batch_aggregated 5000
```

# Build with
- Python 3 (tested with 3.8.2) and R (3.6.3)
